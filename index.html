// 新しい写真アップロード処理
async function handleFiles(files) {
    if (selectedService !== 'imgur') {
        showNotification('写真をアップロードするには、まずImgurサービスを選択してください。', 'warning');
        return;
    }

    const clientId = 'YOUR_IMGUR_CLIENT_ID'; // ⬅️ ここにあなたのImgurクライアントIDを貼り付けてください

    for (const file of Array.from(files)) {
        if (file.type.startsWith('image/') && file.size <= 10 * 1024 * 1024) {
            showNotification(`${file.name} をアップロード中...`, 'info');

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: {
                        Authorization: `Client-ID ${clientId}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    const photo = {
                        id: data.data.id,
                        src: data.data.link, // ⬅️ Imgurから返された共有リンクを使用
                        name: file.name,
                        uploadDate: new Date().toLocaleDateString('ja-JP')
                    };
                    uploadedPhotos.push(photo);
                    updatePhotosDisplay();
                    updateShareLink();
                    saveAlbumData();
                    showNotification(`${file.name} のアップロードが完了しました！`, 'success');
                } else {
                    throw new Error('Imgurアップロード失敗');
                }
            } catch (error) {
                console.error('アップロードエラー:', error);
                showNotification(`${file.name} のアップロードに失敗しました。`, 'error');
            }
        } else {
            showNotification(`${file.name} は対応していない形式またはサイズが大きすぎます。`, 'warning');
        }
    }
}

// データ保存・読み込み関数の修正
function saveAlbumData() {
    const albumData = {
        familyName: familyName,
        members: members,
        photos: uploadedPhotos.map(photo => ({
            id: photo.id,
            name: photo.name,
            uploadDate: photo.uploadDate,
            src: photo.src // ⬅️ 共有リンクを保存
        })),
        selectedService: selectedService,
        lastUpdated: new Date().toISOString()
    };
    
    try {
        localStorage.setItem('famipic_' + albumId, JSON.stringify(albumData));
    } catch (e) {
        console.warn('データの保存に失敗しました:', e);
        showNotification('データの保存に失敗しました。', 'warning');
    }
}

function loadAlbumData() {
    try {
        const albumDataStr = localStorage.getItem('famipic_' + albumId);
        if (albumDataStr) {
            const albumData = JSON.parse(albumDataStr);
            familyName = albumData.familyName || '';
            members = albumData.members || [];
            selectedService = albumData.selectedService || '';
            uploadedPhotos = albumData.photos || []; // ⬅️ 共有リンクを読み込み

            updateFamilyTitle();
            updateMembersDisplay();
            updatePhotosDisplay();
            updateShareLink();
            
            if (selectedService) {
                const serviceCard = document.querySelector(`[data-service="${selectedService}"]`);
                if (serviceCard) {
                    serviceCard.classList.add('selected');
                    serviceCard.querySelector('.use-service-btn').classList.remove('hidden');
                }
            }
        }
    } catch (e) {
        console.warn('データの読み込みに失敗しました:', e);
        showNotification('データの読み込みに失敗しました', 'error');
    }
}

// 写真表示関数の修正
function updatePhotosDisplay() {
    // ... （変更なし、photo.srcが共有リンクになるためそのまま動作します）
}

// 削除関数の修正
function deletePhoto(photoId) {
    if (confirm('この写真を削除しますか？')) {
        uploadedPhotos = uploadedPhotos.filter(photo => photo.id != photoId);
        // Imgurからは削除されないため、ローカルデータのみ削除します
        updatePhotosDisplay();
        updateShareLink();
        saveAlbumData();
        showNotification('写真を削除しました', 'success');
    }
}
